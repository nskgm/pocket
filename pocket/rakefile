#---------------------------------------------------------------------
# config
#---------------------------------------------------------------------

# 出力実行ファイル名
EXECUTE_FILE = "main.exe"
# C++バージョン
CXX_VER = 14
# ライブラリディレクトリ
INC_DIRS = [
	# 文字列配列
]
LIB_DIRS = [
	# 文字列配列
]
# 事前に定義
DEFINES = [
	# 文字列配列
]
# 事前定義に対しての値を設定
DEFINE_PAIRS = {
	# 文字列に対して値
	# "macro" => 1
}
# 事前にて定義を無効
UNDEFINES = [
	# 文字列配列
]
# デバッグを有効にするか
DEBUG = false
# リリースを有効にするか
RELEASE = false
# 警告を有効にするか
WARNING = true

#---------------------------------------------------------------------
# implementatioin
#---------------------------------------------------------------------
require "rake/clean"
# 中間ファイルディレクトリ
OBJ_DIR = "obj/"
DEP_DIR = OBJ_DIR+"dep/" # dependencies
# 削除対象ファイルorディレクトリ
CLEAN_LIST = [EXECUTE_FILE, "#{OBJ_DIR}*.o", "#{DEP_DIR}*.d", DEP_DIR, OBJ_DIR]
CLEAN.include CLEAN_LIST
CLOBBER.include CLEAN_LIST

#--------------------
# デフォルトタスク
#--------------------
desc "default: build_and_run"
task :default => [:build_and_run]

#--------------------
# 実行ファイルを作成
#--------------------
desc "build #{EXECUTE_FILE}"
task :build => [OBJ_DIR, DEP_DIR, EXECUTE_FILE]

#--------------------
# 実行ファイルを作成し直す
#--------------------
desc "rebuild #{EXECUTE_FILE}"
task :rebuild => [:clean, :reset_timespamp, :build]

#--------------------
# 実行ファイルを実行
#--------------------
desc "execute #{EXECUTE_FILE}"
task :run => [:build] do |t|
	sh "#{EXECUTE_FILE}"
end

#--------------------
# 実行ファイルを作成して実行
#--------------------
desc "build and run: #{EXECUTE_FILE}"
task :build_and_run => [:build, :run]

#--------------------
# 実行ファイルを作成し直して実行
#--------------------
desc "rebuild and run: #{EXECUTE_FILE}"
task :rebuild_and_run => [:rebuild, :run]

#--------------------
# 中間ファイル用ディレクトリ作成
#--------------------
directory OBJ_DIR

#--------------------
# ファイル依存関係ファイルディレクトリ作成
#--------------------
directory DEP_DIR => OBJ_DIR

# 対象コンパイラ
COMPILER = "g++"
# コンパイル対象拡張子
EXT_LIST = [".c", ".cpp", ".cxx"]
# 拡張子に対するファイルの列挙
FILE_LIST = FileList[EXT_LIST.map do |e| "**/*#{e}" end]
# 中間ファイル
OBJ_LIST = FILE_LIST.ext "o"

# ファイル名をディレクトリ＋ファイル名の形で作成
def filename(dir, path, suffix="")
	def replace(d, a, r, s)
		f = File.dirname(a)
		f.gsub!(r, "-")
		"#{d}#{f}-#{File.basename(a, s)}"
	end

	# ディレクトリが含まれている場合は文字列置換
	return replace(dir, path, "/", suffix) if path.index("/") != nil
	return replace(dir, path, "\\", suffix) if path.index("\\") != nil
	# 含まれない場合
	"#{dir}#{File.basename(path, suffix)}"
end
# 依存ファイル出力ディレクトリ
def dep_filename(s)
	"#{filename(DEP_DIR, s, ".*")}.d"
end
# 中間ファイル出力ディレクトリ
def obj_filename(s)
	"#{filename(OBJ_DIR, s, ".*")}.o"
end

# 配列から連結文字列を作成
def array_to_join_string(a, sep=" ")
	tmp = a.map do |e| yield e end if a.length > 0
	r = tmp.join sep if tmp != nil
end
# ハッシュから連結文字列を作成
def hash_to_join_string(a, sep=" ")
	tmp = a.map do |k, v| yield k, v end if a.length > 0
	r = tmp.join sep if tmp != nil
end

# 事前に定義する配列
defines = array_to_join_string DEFINES do |e| "-D#{e}" end
define_pairs = hash_to_join_string DEFINE_PAIRS do |k, v| "-D#{k}=#{v}" end
undefines = array_to_join_string UNDEFINES do |e| "-U#{e}" end
# ライブラリ文字列の連結
inc = array_to_join_string INC_DIRS do |e| "-I#{e}" end
lib = array_to_join_string LIB_DIRS do |e| "-L#{e}" end

# 拡張子に対する中間ファイルルールを生成
EXT_LIST.each do |ext|
	#--------------------
	# 指定拡張子用作成ルール
	#--------------------
	rule ".o" => ext do |t|
		# 対象ファイル名
		name = obj_filename t.source
		#--------------------
		# ルールで検出したファイルの変更監視
		#--------------------
		file name => t.source do |ft|
			# 依存ヘッダーファイル
			obj = dep_filename ft.source
			# -MM システムinclude以外の依存includeを調べるファイル
			# -MT 中間ファイルターゲット名
			# -MF 出力ファイルパス
			sh "#{COMPILER} -MM #{ft.source} -MT #{ft.name} -MF #{obj}"

			# 実行するシェルコマンド
			command = "#{COMPILER} -c #{ft.source} -o #{ft.name} -std=c++#{CXX_VER}" # CXX_VERでソースをコンパイル
			command += " -Wall -Wextra -Wcast-qual" if WARNING # 警告
			command += " -w" unless WARNING # 警告をすべて無効
			command += " -g" if DEBUG # デバッグ情報をつける
			command += " -O2 -march=native" if RELEASE # 最高の最適化＋コンパイルマシン最適化
			command += " #{inc}" if inc != nil # システムinclude
			command += " #{lib}" if lib != nil # システムlibrary
			command += " #{defines}" if defines != nil # 事前定義
			command += " #{define_pairs}" if define_pairs != nil # 事前定義+値
			command += " #{undefines}" if undefines != nil # 事前定義無効
			# シェル実行
			sh command
		end
		# 上で作成したタスク実行
		file(name).invoke
	end
end

task :dependencies => [OBJ_DIR, DEP_DIR] do
	DEP_LIST = FileList["#{DEP_DIR}*.d"]
end

#--------------------
# 実行ファイル作成
#--------------------
file EXECUTE_FILE => OBJ_LIST do |t|
	# 中間ファイル名リスト
	obj_list = t.prerequisites.map do |n| obj_filename n end
	command = "#{COMPILER} -o #{EXECUTE_FILE} #{obj_list.join(" ")} -std=c++#{CXX_VER} -lm"
	sh command
end

task :reset_timespamp do
	FileUtils.touch FILE_LIST
end

task :test => OBJ_LIST do
	DEP_LIST = FileList["#{DEP_DIR}*.d"]

	abs = File.expand_path __FILE__
	dir = File.dirname abs

	table = {}

	DEP_LIST.each do |fname|
		# ファイル全体取得
		all = File.read fname
		# 邪魔な文字を削除
		["\\", "\n"].each do |s| all.delete! s end
		# 空白で分割
		arg = all.split ' '

		# キー
		key = arg[0]
		key.strip!
		key.delete! ":"
		# 中間ファイル名とソースファイル名を削除
		2.times do arg.shift end

		# パスの正規化
		res = []
		arg.each do |s|
			s.strip!
			a = File.expand_path s
			len = a.length - dir.length
			res.push a.slice(dir.length+1, len)
			#next unless s.index "../" != nil
		end

		table[key] = res
		#p arg
	end

	p table
end